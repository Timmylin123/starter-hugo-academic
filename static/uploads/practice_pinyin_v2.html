<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pinyin Typing Trainer</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    text-align: center;
    background: #f7f9fc;
    padding: 40px;
  }

  h1 { color: #1e3a8a; }

  #char {
    font-size: 120px;
    margin: 30px 0;
    transition: transform 0.2s;
  }

  #char.correct { transform: scale(1.2); color: #2e7d32; }
  #char.wrong { transform: scale(0.9); color: #c62828; }

  input {
    font-size: 24px;
    padding: 10px;
    width: 300px;
    text-align: center;
    border-radius: 8px;
    border: 2px solid #ccc;
  }

  button {
    font-size: 16px;
    padding: 10px 18px;
    margin: 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
  }

  #startBtn {
    background: #1e3a8a;
    color: white;
  }

  #clearBtn {
    background: #9ca3af;
  }

  table {
    margin: 20px auto;
    border-collapse: collapse;
    width: 90%;
    max-width: 750px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px;
  }

  th {
    background: #1e3a8a;
    color: white;
  }

  .correct-answer { color: #2e7d32; font-weight: bold; }
  .wrong-answer { color: #c62828; font-weight: bold; }
</style>
</head>

<body>

<h1>Pinyin Typing Trainer</h1>

<div id="char">‚Äî</div>

<input
  id="input"
  type="text"
  disabled
  placeholder="type pinyin, press Enter"
/>

<div id="feedback"></div>
<div id="timer"></div>

<div>
  <button id="startBtn" onclick="startGame()">Play</button>
  <button id="clearBtn" onclick="clearProgress()">Clear Progress</button>
</div>

<div id="summary"></div>

<script>
/* ===================== DATA ===================== */

const deck = [
    { char: "Èòø", pinyin: "a" },
    { char: "Áà∏", pinyin: "ba" },
    { char: "Ë∂¥", pinyin: "pa" },
    { char: "Â™Ω", pinyin: "ma" },
    { char: "ÁΩ∞", pinyin: "fa" },      
    { char: "ÈÅî", pinyin: "da" },
    { char: "‰ªñ", pinyin: "ta" },
    { char: "ÈÇ£", pinyin: "na" },
    { char: "Êãâ", pinyin: "la" },
    { char: "Âòé", pinyin: "ga" },
    { char: "Âç°", pinyin: "ka" },
    { char: "Âìà", pinyin: "ha" },
    { char: "ÁÇ∏", pinyin: "zha" },
    { char: "Êü•", pinyin: "cha" },
    { char: "Ê≤ô", pinyin: "sha" },
    { char: "Êâé", pinyin: "za" },
    { char: "Êì¶", pinyin: "ca" },
    { char: "Êíí", pinyin: "sa" },
    { char: "Ëâæ", pinyin: "ai" },
    { char: "ÁôΩ", pinyin: "bai" },
    { char: "Êãç", pinyin: "pai" },
    { char: "Ë≤∑", pinyin: "mai" },
    { char: "‰ª£", pinyin: "dai" },
    { char: "Â§™", pinyin: "tai" },
    { char: "Â•à", pinyin: "nai" },
    { char: "Ëêä", pinyin: "lai" },
    { char: "Êîπ", pinyin: "gai" },
    { char: "Èñã", pinyin: "kai" },
    { char: "Êµ∑", pinyin: "hai" },
    { char: "ÂÆÖ", pinyin: "zhai" },
    { char: "ÊãÜ", pinyin: "chai" },
    { char: "Êõ¨", pinyin: "shai" },
    { char: "Âú®", pinyin: "zai" },
    { char: "Ëèú", pinyin: "cai" },
    { char: "Ë≥Ω", pinyin: "sai" },
    { char: "ÂÆâ", pinyin: "an" },
    { char: "Áè≠", pinyin: "ban" },
    { char: "Áõ§", pinyin: "pan" },
    { char: "Êªø", pinyin: "man" },
    { char: "Âá°", pinyin: "fan" },
    { char: "ÂñÆ", pinyin: "dan" },
    { char: "Ë´á", pinyin: "tan" },
    { char: "Âçó", pinyin: "nan" },
    { char: "Ëò≠", pinyin: "lan" },
    { char: "Êï¢", pinyin: "gan" },     
    { char: "Âùé", pinyin: "kan" },
    { char: "Êº¢", pinyin: "han" },
    { char: "Á´ô", pinyin: "zhan" },
    { char: "Áî¢", pinyin: "chan" },
    { char: "Â±±", pinyin: "shan" },
    { char: "ÁÑ∂", pinyin: "ran" },
    { char: "Ë¥ä", pinyin: "zan" },
    { char: "È§ê", pinyin: "can" },
    { char: "Êï£", pinyin: "san" },
    { char: "ÊòÇ", pinyin: "ang" },
    { char: "Âπ´", pinyin: "bang" },
    { char: "ËÉñ", pinyin: "pang" },
    { char: "Âøô", pinyin: "mang" },
    { char: "Êñπ", pinyin: "fang" },
    { char: "Áï∂", pinyin: "dang" },    
    { char: "Âîê", pinyin: "tang" },
    { char: "Âõä", pinyin: "nang" },
    { char: "Êúó", pinyin: "lang" },
    { char: "Â≤°", pinyin: "gang" },
    { char: "Â∫∑", pinyin: "kang" },
    { char: "Êù≠", pinyin: "hang" },
    { char: "Âºµ", pinyin: "zhang" },
    { char: "Â†¥", pinyin: "chang" },
    { char: "‰∏ä", pinyin: "shang" },
    { char: "ËÆì", pinyin: "rang" },
    { char: "È´í", pinyin: "zang" },    
    { char: "ÂÄâ", pinyin: "cang" },
    { char: "Ê°ë", pinyin: "sang" },
    { char: "Â•ß", pinyin: "ao" },
    { char: "ÂØ∂", pinyin: "bao" },
    { char: "Ë∑ë", pinyin: "pao" },
    { char: "ÊØõ", pinyin: "mao" },
    { char: "Âà∞", pinyin: "dao" },
    { char: "Ê°É", pinyin: "tao" },
    { char: "ËÖ¶", pinyin: "nao" },
    { char: "ËÄÅ", pinyin: "lao" },
    { char: "È´ò", pinyin: "gao" },
    { char: "ËÄÉ", pinyin: "kao" },
    { char: "Â•Ω", pinyin: "hao" },
    { char: "Êâæ", pinyin: "zhao" },
    { char: "Ë∂Ö", pinyin: "chao" },
    { char: "Â∞ë", pinyin: "shao" },
    { char: "È•í", pinyin: "rao" },
    { char: "Êó©", pinyin: "zao" },
    { char: "Ëçâ", pinyin: "cao" },
    { char: "ÊéÉ", pinyin: "sao" },
    { char: "Èµù", pinyin: "e" },
    { char: "È∫º", pinyin: "me" },
    { char: "Âæ∑", pinyin: "de" },      
    { char: "Áâπ", pinyin: "te" },
    { char: "Âë¢", pinyin: "ne" },
    { char: "Âãí", pinyin: "le" },       
    { char: "Âì•", pinyin: "ge" },
    { char: "ÂÖã", pinyin: "ke" },
    { char: "Âñù", pinyin: "he" },
    { char: "ÈÄô", pinyin: "zhe" },
    { char: "Ëªä", pinyin: "che" },
    { char: "Á§æ", pinyin: "she" },
    { char: "ÁÜ±", pinyin: "re" },
    { char: "Ââá", pinyin: "ze" },
    { char: "Á≠ñ", pinyin: "ce" },
    { char: "Ëâ≤", pinyin: "se" },
    { char: "Ë™í", pinyin: "ei" },
    { char: "Âåó", pinyin: "bei" },
    { char: "ÈÖç", pinyin: "pei" },
    { char: "Áæé", pinyin: "mei" },
    { char: "Èùû", pinyin: "fei" },
    { char: "ÂÖß", pinyin: "nei" },
    { char: "Èõ∑", pinyin: "lei" },     
    { char: "Áµ¶", pinyin: "gei" },
    { char: "Èªë", pinyin: "hei" },
    { char: "Ë™∞", pinyin: "shei" },     
    { char: "Ë≥ä", pinyin: "zei" },
    { char: "ÊÅ©", pinyin: "en" },
    { char: "Êú¨", pinyin: "ben" },
    { char: "Âô¥", pinyin: "pen" },
    { char: "ÂÄë", pinyin: "men" },
    { char: "ÂàÜ", pinyin: "fen" },
    { char: "Â´©", pinyin: "nen" },
    { char: "Ê†π", pinyin: "gen" },
    { char: "ËÇØ", pinyin: "ken" },
    { char: "ÊÅ®", pinyin: "hen" },
    { char: "Áúü", pinyin: "zhen" },
    { char: "Êô®", pinyin: "chen" },
    { char: "Á•û", pinyin: "shen" },
    { char: "‰∫∫", pinyin: "ren" },
    { char: "ÊÄé", pinyin: "zen" },
    { char: "Â≤ë", pinyin: "cen" },
    { char: "Ê£Æ", pinyin: "sen" },
    { char: "Â¥©", pinyin: "beng" },
    { char: "Êúã", pinyin: "peng" },
    { char: "Â§¢", pinyin: "meng" },
    { char: "È¢®", pinyin: "feng" },
    { char: "Áôª", pinyin: "deng" },
    { char: "È®∞", pinyin: "teng" },
    { char: "ËÉΩ", pinyin: "neng" },
    { char: "ÂÜ∑", pinyin: "leng" },
    { char: "Êõ¥", pinyin: "geng" },
    { char: "Âùë", pinyin: "keng" },
    { char: "ÊÅÜ", pinyin: "heng" },
    { char: "Ê≠£", pinyin: "zheng" },
    { char: "Êàê", pinyin: "cheng" },
    { char: "Áîü", pinyin: "sheng" },
    { char: "‰ªç", pinyin: "reng" },
    { char: "Â¢û", pinyin: "zeng" },
    { char: "Â±§", pinyin: "ceng" },
    { char: "ÂÉß", pinyin: "seng" },
    { char: "ÂÖí", pinyin: "er" },
    { char: "‰∏Ä", pinyin: "yi" },
    { char: "ÊØî", pinyin: "bi" },
    { char: "Êâπ", pinyin: "pi" },
    { char: "Á±≥", pinyin: "mi" },
    { char: "Âºü", pinyin: "di" },
    { char: "Ê¢Ø", pinyin: "ti" },
    { char: "‰Ω†", pinyin: "ni" },
    { char: "ÁêÜ", pinyin: "li" },
    { char: "Ê©ü", pinyin: "ji" },
    { char: "Êúü", pinyin: "qi" },
    { char: "Ë•ø", pinyin: "xi" },
    { char: "Áü•", pinyin: "zhi" },
    { char: "ÂêÉ", pinyin: "chi" },
    { char: "ÊòØ", pinyin: "shi" },
    { char: "Êó•", pinyin: "ri" },
    { char: "Â≠ê", pinyin: "zi" },
    { char: "Ê¨°", pinyin: "ci" },
    { char: "Âõõ", pinyin: "si" },
    { char: "‰∫û", pinyin: "ya" },
    { char: "Âó≤", pinyin: "dia" },
    { char: "ÂÆ∂", pinyin: "jia" },
    { char: "ÊÅ∞", pinyin: "qia" },
    { char: "Â§è", pinyin: "xia" },
    { char: "Áúº", pinyin: "yan" },
    { char: "ÈÇä", pinyin: "bian" },
    { char: "ÁØá", pinyin: "pian" },
    { char: "Èù¢", pinyin: "mian" },
    { char: "Èõª", pinyin: "dian" },
    { char: "Â§©", pinyin: "tian" },
    { char: "Âπ¥", pinyin: "nian" },
    { char: "ÈÄ£", pinyin: "lian" },
    { char: "Âª∫", pinyin: "jian" },
    { char: "Ââç", pinyin: "qian" },
    { char: "ÂÖà", pinyin: "xian" },
    { char: "Áæä", pinyin: "yang" },
    { char: "Â®ò", pinyin: "niang" },
    { char: "‰∫Æ", pinyin: "liang" },
    { char: "Ê±ü", pinyin: "jiang" },
    { char: "Âº∑", pinyin: "qiang" },
    { char: "È¶ô", pinyin: "xiang" },
    { char: "Ë¶Å", pinyin: "yao" },
    { char: "Ê®ô", pinyin: "biao" },
    { char: "Á•®", pinyin: "piao" },
    { char: "Áßí", pinyin: "miao" },
    { char: "Êéâ", pinyin: "diao" },
    { char: "Ê¢ù", pinyin: "tiao" },
    { char: "È≥•", pinyin: "niao" },
    { char: "ÁôÇ", pinyin: "liao" },
    { char: "Âè´", pinyin: "jiao" },
    { char: "Ê©ã", pinyin: "qiao" },
    { char: "Á¨ë", pinyin: "xiao" },
    { char: "‰πü", pinyin: "ye" },
    { char: "Âà•", pinyin: "bie" },
    { char: "Êíá", pinyin: "pie" },
    { char: "ÊªÖ", pinyin: "mie" },
    { char: "Áñä", pinyin: "die" },
    { char: "Ë≤º", pinyin: "tie" },
    { char: "Êçè", pinyin: "nie" },
    { char: "Âàó", pinyin: "lie" },
    { char: "Êé•", pinyin: "jie" },
    { char: "Âàá", pinyin: "qie" },
    { char: "ÂØ´", pinyin: "xie" },
    { char: "Âõ†", pinyin: "yin" },
    { char: "Ë≥ì", pinyin: "bin" },
    { char: "ÂìÅ", pinyin: "pin" },
    { char: "Ê∞ë", pinyin: "min" },
    { char: "ÊÇ®", pinyin: "nin" },
    { char: "Êûó", pinyin: "lin" },
    { char: "Èáë", pinyin: "jin" },
    { char: "Ë¶™", pinyin: "qin" },
    { char: "ÂøÉ", pinyin: "xin" },
    { char: "ÂΩ±", pinyin: "ying" },
    { char: "ÂÖµ", pinyin: "bing" },
    { char: "Âπ≥", pinyin: "ping" },
    { char: "Êòé", pinyin: "ming" },
    { char: "‰∏Å", pinyin: "ding" },
    { char: "‰∫≠", pinyin: "ting" },
    { char: "ÂØß", pinyin: "ning" },
    { char: "Èùà", pinyin: "ling" },
    { char: "‰∫¨", pinyin: "jing" },
    { char: "Èùí", pinyin: "qing" },
    { char: "Êòü", pinyin: "xing" },
    { char: "Âî∑", pinyin: "yo" },  
    { char: "Ê∞∏", pinyin: "yong" },
    { char: "Âõß", pinyin: "jiong" },
    { char: "Áìä", pinyin: "qiong" },
    { char: "ÈõÑ", pinyin: "xiong" },
    { char: "Êúâ", pinyin: "you" },
    { char: "Ë¨¨", pinyin: "miu" },
    { char: "Áâõ", pinyin: "niu" },
    { char: "Êü≥", pinyin: "liu" },
    { char: "ÈÖí", pinyin: "jiu" },
    { char: "ÁêÉ", pinyin: "qiu" },
    { char: "‰ºë", pinyin: "xiu" },
    { char: "Âñî", pinyin: "o" },
    { char: "Ê≥¢", pinyin: "bo" }, 
    { char: "Âù°", pinyin: "po" },
    { char: "Êë∏", pinyin: "mo" },
    { char: "‰Ωõ", pinyin: "fo" },
    { char: "ÂíØ", pinyin: "lo" },
    { char: "ÁøÅ", pinyin: "weng" },
    { char: "Êù±", pinyin: "dong" },
    { char: "Âêå", pinyin: "tong" },
    { char: "Ëæ≤", pinyin: "nong" },
    { char: "Èæç", pinyin: "long" },
    { char: "Â∑•", pinyin: "gong" },
    { char: "Á©∫", pinyin: "kong" },
    { char: "Á¥Ö", pinyin: "hong" },
    { char: "‰∏≠", pinyin: "zhong" },
    { char: "Ë°ù", pinyin: "chong" },
    { char: "Ê¶Æ", pinyin: "rong" },
    { char: "Á∏Ω", pinyin: "zong" },
    { char: "Âæû", pinyin: "cong" },
    { char: "Êùæ", pinyin: "song" },
    { char: "Ê≠ê", pinyin: "ou" },
    { char: "Ââñ", pinyin: "pou" },
    { char: "Êüê", pinyin: "mou" },
    { char: "Âê¶", pinyin: "fou" },
    { char: "ÈÉΩ", pinyin: "dou" },
    { char: "È†≠", pinyin: "tou" },
    { char: "Ê®ì", pinyin: "lou" },
    { char: "Áãó", pinyin: "gou" },
    { char: "Âè£", pinyin: "kou" },
    { char: "Âæå", pinyin: "hou" },
    { char: "Âë®", pinyin: "zhou" },
    { char: "ÊäΩ", pinyin: "chou" },
    { char: "Êâã", pinyin: "shou" },
    { char: "ËÇâ", pinyin: "rou" },
    { char: "Ëµ∞", pinyin: "zou" },
    { char: "Êπä", pinyin: "cou" },
    { char: "Êêú", pinyin: "sou" },
    { char: "‰∫î", pinyin: "wu" },
    { char: "‰∏ç", pinyin: "bu" },
    { char: "ÊôÆ", pinyin: "pu" },
    { char: "ÊØç", pinyin: "mu" },
    { char: "Áà∂", pinyin: "fu" },
    { char: "ËÆÄ", pinyin: "du" },
    { char: "Âúñ", pinyin: "tu" },
    { char: "Â•¥", pinyin: "nu" },
    { char: "Ë∑Ø", pinyin: "lu" },
    { char: "Âè§", pinyin: "gu" },
    { char: "Ëã¶", pinyin: "ku" },
    { char: "Ëôé", pinyin: "hu" },
    { char: "Êú±", pinyin: "zhu" },
    { char: "Âá∫", pinyin: "chu" },
    { char: "Êõ∏", pinyin: "shu" },
    { char: "Â¶Ç", pinyin: "ru" },
    { char: "Á•ñ", pinyin: "zu" },
    { char: "Á≤ó", pinyin: "cu" },
    { char: "Ëòá", pinyin: "su" },
    { char: "Â®É", pinyin: "wa" },
    { char: "Áìú", pinyin: "gua" },
    { char: "Â§∏", pinyin: "kua" },
    { char: "Ëä±", pinyin: "hua" },
    { char: "Êäì", pinyin: "zhua" },
    { char: "Âà∑", pinyin: "shua" },
    { char: "Â§ñ", pinyin: "wai" },
    { char: "ÊÄ™", pinyin: "guai" },
    { char: "Âø´", pinyin: "kuai" },
    { char: "Êá∑", pinyin: "huai" },
    { char: "Ë∏π", pinyin: "chuai" },
    { char: "Ë°∞", pinyin: "shuai" },
    { char: "ÂÆå", pinyin: "wan" },
    { char: "Á´Ø", pinyin: "duan" },
    { char: "Âúò", pinyin: "tuan" },
    { char: "Êöñ", pinyin: "nuan" },
    { char: "Âçµ", pinyin: "luan" },
    { char: "Èóú", pinyin: "guan" },
    { char: "ÂØ¨", pinyin: "kuan" },
    { char: "Ê≠°", pinyin: "huan" },
    { char: "ËΩâ", pinyin: "zhuan" },
    { char: "Â∑ù", pinyin: "chuan" },
    { char: "Ê†ì", pinyin: "shuan" },
    { char: "Ëªü", pinyin: "ruan" },
    { char: "ÈëΩ", pinyin: "zuan" },
    { char: "Á´Ñ", pinyin: "cuan" },
    { char: "ÁÆó", pinyin: "suan" },
    { char: "Áéã", pinyin: "wang" },
    { char: "ÂÖâ", pinyin: "guang" },
    { char: "Ê°Ü", pinyin: "kuang" },
    { char: "ÈªÉ", pinyin: "huang" },
    { char: "Â£Ø", pinyin: "zhuang" },
    { char: "Â∫ä", pinyin: "chuang" },
    { char: "ÁàΩ", pinyin: "shuang" },
    { char: "Á¥Ñ", pinyin: "yue" },
    { char: "Ëôê", pinyin: "nve" },
    { char: "Áï•", pinyin: "lve" },
    { char: "Ê±∫", pinyin: "jue" },
    { char: "Âçª", pinyin: "que" },
    { char: "Â≠∏", pinyin: "xue" },
    { char: "ÁÇ∫", pinyin: "wei" },
    { char: "Â∞ç", pinyin: "dui" },
    { char: "Êé®", pinyin: "tui" },
    { char: "Ë≤¥", pinyin: "gui" },
    { char: "ÊÑß", pinyin: "kui" },
    { char: "ÊÖß", pinyin: "hui" },
    { char: "ËøΩ", pinyin: "zhui" },
    { char: "Âêπ", pinyin: "chui" },
    { char: "Ê∞¥", pinyin: "shui" },
    { char: "Áëû", pinyin: "rui" },
    { char: "ÁΩ™", pinyin: "zui" },
    { char: "ÂÇ¨", pinyin: "cui" },
    { char: "Èö®", pinyin: "sui" },
    { char: "Êñá", pinyin: "wen" },
    { char: "È†ì", pinyin: "dun" },
    { char: "Â±Ø", pinyin: "tun" },
    { char: "Ë´ñ", pinyin: "lun" },
    { char: "Êªæ", pinyin: "gun" },
    { char: "ÊòÜ", pinyin: "kun" },
    { char: "Ê∑∑", pinyin: "hun" },
    { char: "Ê∫ñ", pinyin: "zhun" },
    { char: "Êò•", pinyin: "chun" },
    { char: "È†Ü", pinyin: "shun" },
    { char: "ÊΩ§", pinyin: "run" },
    { char: "Â∞ä", pinyin: "zun" },
    { char: "Â≠ò", pinyin: "cun" },
    { char: "Êêç", pinyin: "sun" },
    { char: "Êàë", pinyin: "wo" },
    { char: "Â§ö", pinyin: "duo" },
    { char: "Êâò", pinyin: "tuo" },
    { char: "Êå™", pinyin: "nuo" },
    { char: "ÁæÖ", pinyin: "luo" },
    { char: "Âúã", pinyin: "guo" },
    { char: "Êì¥", pinyin: "kuo" },
    { char: "ÁÅ´", pinyin: "huo" },
    { char: "Ê°å", pinyin: "zhuo" },
    { char: "Êà≥", pinyin: "chuo" },
    { char: "Ë™™", pinyin: "shuo" },
    { char: "Ëã•", pinyin: "ruo" },
    { char: "‰Ωú", pinyin: "zuo" },
    { char: "Êé™", pinyin: "cuo" },
    { char: "ÊâÄ", pinyin: "suo" },
    { char: "Ë™û", pinyin: "yu" },
    { char: "Â•≥", pinyin: "nv" }, // only pronounced "n√º"
    { char: "Á∂†", pinyin: "lv" }, // only pronounced "l√º"
    { char: "Â±Ä", pinyin: "ju" },
    { char: "Âèñ", pinyin: "qu" },
    { char: "ÈúÄ", pinyin: "xu" },
    { char: "Âúí", pinyin: "yuan" },
    { char: "Âç∑", pinyin: "juan" },
    { char: "ÂÖ®", pinyin: "quan" },
    { char: "ÂÆ£", pinyin: "xuan" },
    { char: "Èõ≤", pinyin: "yun" },
    { char: "Âêõ", pinyin: "jun" },
    { char: "Áæ§", pinyin: "qun" },
    { char: "Â∞ã", pinyin: "xun" }
    ];

/* ===================== STATE ===================== */

let questions = [];
let current = null;
let index = 0;
let timer = null;
let timeLeft = 3;
let userAnswers = [];

const statsKey = "pinyinStats";
let stats = JSON.parse(localStorage.getItem(statsKey)) || {};

/* ===================== ELEMENTS ===================== */

const charDiv = document.getElementById("char");
const input = document.getElementById("input");
const feedback = document.getElementById("feedback");
const timerDiv = document.getElementById("timer");
const summaryDiv = document.getElementById("summary");
const startBtn = document.getElementById("startBtn");

/* ===================== HELPERS ===================== */

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function initStats(char) {
  if (!stats[char]) {
    stats[char] = { seen: 0, correct: 0, wrong: 0 };
  }
}

function saveStats() {
  localStorage.setItem(statsKey, JSON.stringify(stats));
}

/* ===================== GAME FLOW ===================== */

function startGame() {
  shuffle(deck);

  //UNIQUE-SELECTION LOGIC
  const usedChars = new Set();
  questions = [];

  for (const card of deck) {
    if (!usedChars.has(card.char)) {
      questions.push(card);
      usedChars.add(card.char);
    }
    if (questions.length === 10) break;
  }

  index = 0;
  userAnswers = [];
  input.disabled = false;
  startBtn.disabled = true;
  summaryDiv.innerHTML = "";
  nextChar();
  input.focus();
}

function nextChar() {
  if (index >= questions.length) {
    endGame();
    return;
  }

  current = questions[index];
  charDiv.textContent = current.char;
  charDiv.className = "";
  input.value = "";
  feedback.textContent = "";

  timeLeft = 3;
  timerDiv.textContent = `‚è± ${timeLeft}s`;

  clearInterval(timer);
  timer = setInterval(() => {
    timeLeft--;
    timerDiv.textContent = `‚è± ${timeLeft}s`;
    if (timeLeft <= 0) {
      clearInterval(timer);
      checkAnswer("");
    }
  }, 1000);
}

input.addEventListener("keydown", e => {
  if (e.key === "Enter") checkAnswer(input.value.trim().toLowerCase());
});

function checkAnswer(answer) {
  clearInterval(timer);

  initStats(current.char);
  stats[current.char].seen++;

  const correct = answer === current.pinyin;

  if (correct) {
    stats[current.char].correct++;
    charDiv.className = "correct";
    feedback.textContent = "‚úÖ Correct";
  } else {
    stats[current.char].wrong++;
    charDiv.className = "wrong";
    feedback.textContent = `‚ùå ${current.pinyin}`;
  }

  userAnswers.push({
    char: current.char,
    pinyin: current.pinyin,
    answer: answer || "(none)"
  });

  saveStats();
  index++;
  setTimeout(nextChar, 500);
}

/* ===================== SUMMARY ===================== */

function endGame() {
  input.disabled = true;
  startBtn.disabled = false;
  charDiv.textContent = "üéâ";
  timerDiv.textContent = "";

  let score = userAnswers.filter(a => a.answer === a.pinyin).length;

  let html = `<h2>Summary</h2>`;
  html += `<p>Score: ${score} / ${userAnswers.length}</p>`;

  html += `<table>
    <tr><th>#</th><th>Char</th><th>Your Answer</th><th>Correct</th></tr>`;

  userAnswers.forEach((a, i) => {
    const c = a.answer === a.pinyin ? "correct-answer" : "wrong-answer";
    html += `<tr>
      <td>${i + 1}</td>
      <td>${a.char}</td>
      <td class="${c}">${a.answer}</td>
      <td>${a.pinyin}</td>
    </tr>`;
  });

  html += `</table>`;
  summaryDiv.innerHTML = html;
}

/* ===================== CLEAR CACHE ===================== */

function clearProgress() {
  if (!confirm("Clear all saved progress for this device?")) return;
  localStorage.removeItem(statsKey);
  stats = {};
  summaryDiv.innerHTML = "<p>Progress cleared. Ready for a new player.</p>";
}
</script>

</body>
</html>
